<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FerBot ¬∑ Panel</title>
<style>
/* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
   FerBot ¬∑ Panel unificado
   ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
:root{
  --platzi:#97C93E; --platzi-2:#7FB02F;
  --ink:#E6F2FF; --mut:#94a3b8;
  --card:#0f162a80; --stroke:rgba(255,255,255,.12);
  --field:#0f1524;
}
*{box-sizing:border-box}
html,body{
  height:100%; margin:0; color:var(--ink);
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
  background:
    radial-gradient(1200px 600px at 10% -20%, rgba(151,201,62,.18), transparent 60%),
    radial-gradient(1000px 500px at 100% 0%, rgba(151,201,62,.12), transparent 55%),
    linear-gradient(180deg, #0b0f19 0%, #0b0f19 35%, #0d1122 100%);
  overflow-y:auto;
}
body::before{
  content:""; position:fixed; inset:0;
  background:
    linear-gradient(to right, rgba(255,255,255,.03) 1px, transparent 1px) 0 0/24px 24px,
    linear-gradient(to bottom, rgba(255,255,255,.03) 1px, transparent 1px) 0 0/24px 24px;
  pointer-events:none; mask:linear-gradient(#000, transparent 85%);
}
.wrap{max-width:980px; margin:28px auto 64px; padding:0 16px}
.header{display:flex; align-items:center; justify-content:space-between; margin:0 0 12px}
h1{margin:0; font-size:22px; letter-spacing:.2px; display:flex; align-items:center; gap:10px}
h1::after{content:""; display:block; width:120px; height:2px; border-radius:2px;
  background:linear-gradient(90deg, rgba(151,201,62,.0), rgba(151,201,62,.65), rgba(151,201,62,.0));}

/* NAV (tabs) */
.nav{
  display:flex; gap:8px; margin:10px 0 16px; flex-wrap:wrap;
  background:rgba(16,23,39,.5); border:1px solid var(--stroke); border-radius:12px; padding:6px;
}
.tab{
  appearance:none; border:1px solid transparent; background:transparent; color:#bed6ff;
  padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700; letter-spacing:.2px;
}
.tab:hover{border-color:var(--stroke)}
.tab.active{
  color:#062d1f;
  background:linear-gradient(180deg, var(--platzi) 0%, var(--platzi-2) 100%);
  box-shadow: 0 6px 16px rgba(151,201,62,.2);
}

/* tarjeta glass */
.card{
  background:var(--card); border:1px solid var(--stroke);
  box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
  backdrop-filter: blur(8px); border-radius:18px; padding:18px; position:relative;
}
.card::before{
  content:""; position:absolute; inset:-1px; border-radius:18px; padding:1px;
  background:linear-gradient(135deg, rgba(151,201,62,.6), rgba(151,201,62,0) 45%, rgba(151,201,62,.35));
  -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none;
}

/* layout form */
.row{display:flex; gap:12px; align-items:flex-start}
.row>div{flex:1}
label{display:block; font-size:12px; color:var(--mut); margin:8px 0 6px}
input,select,textarea{
  width:100%; background:var(--field); border:1px solid var(--stroke); color:#D7E7FF;
  border-radius:12px; padding:12px 12px; outline:none; transition:border-color .15s, box-shadow .15s, background .2s;
}
textarea{min-height:96px; resize:vertical}
input:focus,select:focus,textarea:focus{border-color: rgba(151,201,62,.65); box-shadow: 0 0 0 3px rgba(151,201,62,.15)}

/* sentiment badge + timer */
.badge{
  display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:6px 10px;
  border-radius:999px; border:1px solid var(--stroke); background:rgba(16,23,39,.85); height:32px; margin:0 0 6px 6px;
}
.badge .dot{width:8px;height:8px;border-radius:50%; background:#64748b}
.badge.pos .dot{background:#22c55e} .badge.neu .dot{background:#f59e0b} .badge.neg .dot{background:#ef4444}
.signal{display:inline-flex; align-items:center; gap:8px; background:rgba(16,23,39,.8); border:1px solid var(--stroke); padding:6px 12px; border-radius:999px; font-variant-numeric:tabular-nums}
.bullet{width:10px;height:10px;border-radius:999px;background:#ef4444; box-shadow:0 0 12px #ef4444}
.bullet.amber{background:#f59e0b; box-shadow:0 0 12px #f59e0b}
.bullet.green{background:#22c55e; box-shadow:0 0 12px #22c55e}

/* botones */
.btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
.btn{padding:12px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:800; letter-spacing:.2px; transition: transform .05s ease, filter .2s}
.btn:active{ transform: translateY(1px) }
.primary{color:#062d1f;background:linear-gradient(180deg, var(--platzi) 0%, var(--platzi-2) 100%);box-shadow: 0 6px 16px rgba(151,201,62,.28)}
.ghost{ background:#1b2333; color:#cfe3ff; border:1px solid var(--stroke) }
.good{ background:#19c37d; color:#062d1f; display:none }
.reg { background:#fbbf24; color:#332200; display:none }
.bad { background:#ef4444; color:#fff; display:none }

/* helpers */
.hidden{display:none !important}
.footer{margin:18px 0 0; text-align:center; color:var(--mut); font-size:12px; opacity:.7}
.footer code{color:#8BD626}
.small{font-size:12px;color:#9fb6d6}
.hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0;border:0}
kbd{background:#0f1524;border:1px solid var(--stroke);border-radius:6px;padding:2px 6px;font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>FerBot ü§ñ ¬∑ Panel</h1>
      <span class="signal"><span id="b" class="bullet"></span><span id="t">0.0s</span></span>
    </div>

    <!-- NAV (tabs internas, sin rutas nuevas) -->
    <nav class="nav">
      <button class="tab active" data-view="view-panel">Panel</button>
      <button class="tab" data-view="view-metrics">M√©tricas</button>
      <button class="tab" data-view="view-ranking">Ranking</button>
      <button class="tab" data-view="view-install">Instalaci√≥n</button>
    </nav>

    <!-- ====================== VISTA: PANEL ====================== -->
    <section id="view-panel">
      <div class="card">
        <div class="row">
          <div>
            <label>Nombre del cliente</label>
            <input id="name" placeholder="Ej. Laura"/>
          </div>
          <div>
            <label>Etapa</label>
            <select id="stage">
              <option value="integracion">Integraci√≥n</option>
              <option value="sondeo">Sondeo</option>
              <option value="rebatir" selected>Rebatir</option>
              <option value="pre_cierre">Pre-cierre</option>
              <option value="cierre">Cierre</option>
            </select>
          </div>
        </div>

        <label>Contexto (opcional)</label>
        <input id="ctx" placeholder="Notas breves para el bot..."/>

        <div class="row" style="align-items:flex-end;margin-top:10px">
          <div style="flex:1">
            <label>Texto del cliente / Objeci√≥n</label>
            <textarea id="in" placeholder="Selecciona texto del chat o escribe aqu√≠..."></textarea>
          </div>
          <div class="badge neu" id="sent">
            <span class="dot"></span><span id="sTxt">Neutral</span>
          </div>
        </div>

        <label>Explicaci√≥n (POR QU√â + SIGUIENTE PASO)</label>
        <textarea id="guide" placeholder="Aqu√≠ ver√°s POR QU√â y el SIGUIENTE PASO..."></textarea>

        <label>Respuesta (lista para pegar)</label>
        <textarea id="out" placeholder="Mensaje breve (‚â§ 2 frases)."></textarea>

        <div class="btns">
          <button id="gen" class="btn primary">Generar</button>
          <button id="clr" class="btn ghost">Clear</button>
          <button id="g" class="btn good">üëç Buena</button>
          <button id="r" class="btn reg">üòê Regular</button>
          <button id="b1" class="btn bad">üëé Mala</button>
        </div>

        <div class="footer">
          // api: <code id="api-hint">loading‚Ä¶</code>
        </div>
      </div>
    </section>

    <!-- ====================== VISTA: M√âTRICAS (placeholder) ====================== -->
    <section id="view-metrics" class="hidden">
      <div class="card">
        <h3 style="margin:0 0 12px">M√©tricas (pr√≥ximo paso)</h3>
        <p class="small">Ver√°s tarjetas (chats 24h, winrate, latencia) y gr√°ficas. Mantendremos este estilo.</p>
        <div class="small">// Usaremos <code>/stats</code> cuando demos el siguiente paso.</div>
      </div>
    </section>

    <!-- ====================== VISTA: RANKING (placeholder) ====================== -->
    <section id="view-ranking" class="hidden">
      <div class="card">
        <h3 style="margin:0 0 12px">Ranking de respuestas (pr√≥ximo paso)</h3>
        <p class="small">Tabla con winrate, shown, intent y stage, basada en <code>/stats</code>. Mismo look del panel.</p>
      </div>
    </section>

    <!-- ====================== VISTA: INSTALACI√ìN (completa) ====================== -->
    <section id="view-install" class="hidden">
      <div class="card">
        <h3 style="margin:0 0 12px">Instalaci√≥n r√°pida (Windows y Mac)</h3>

        <div class="row" style="gap:10px; align-items:center; margin-bottom:10px">
          <a id="dl-link" class="btn primary" href="#" download>‚¨áÔ∏è Descargar extensi√≥n (.zip)</a>
          <button id="copy-dl" class="btn ghost">Copiar enlace</button>
          <button id="probe" class="btn ghost">Probar conexi√≥n</button>
          <span id="probe-out" class="small"></span>
        </div>

        <div class="hr"></div>

        <h4 style="margin:8px 0 6px">1) Descarga y descomprime</h4>
        <ul class="small" style="margin:0 0 10px 16px; line-height:1.6">
          <li>Haz clic en <b>Descargar extensi√≥n (.zip)</b>.</li>
          <li>Abre el ZIP y <b>extrae</b> su contenido a una carpeta. Dentro debes ver <code>manifest.json</code> y <code>contentScript.js</code>.</li>
        </ul>

        <h4 style="margin:8px 0 6px">2) Carga la extensi√≥n en el navegador</h4>
        <div class="row">
          <div>
            <b>Windows (Chrome/Edge)</b>
            <ol class="small" style="margin:6px 0 0 18px; line-height:1.6">
              <li>Abre <b>chrome://extensions/</b> en Chrome (o <b>edge://extensions/</b> en Edge).</li>
              <li>Activa <b>Developer mode</b> (arriba a la derecha).</li>
              <li>Haz clic en <b>Load unpacked</b> / <b>Cargar descomprimida</b>.</li>
              <li>Selecciona la carpeta que descomprimiste (donde est√° <code>manifest.json</code>).</li>
            </ol>
          </div>
          <div>
            <b>Mac (Chrome)</b>
            <ol class="small" style="margin:6px 0 0 18px; line-height:1.6">
              <li>Abre <b>chrome://extensions/</b>.</li>
              <li>Activa <b>Developer mode</b>.</li>
              <li>Clic en <b>Load unpacked</b>.</li>
              <li>Elige la carpeta descomprimida (con <code>manifest.json</code> adentro).</li>
            </ol>
          </div>
        </div>

        <h4 style="margin:12px 0 6px">3) Conectar con el backend (una sola vez)</h4>
        <p class="small" style="margin:0 0 8px">Abre la p√°gina donde usar√°s FerBot (Hilos). Luego:</p>
        <ol class="small" style="margin:0 0 10px 18px; line-height:1.6">
          <li>Abre las herramientas de desarrollador: <kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>I</kbd> (Windows) o <kbd>‚åò</kbd>+<kbd>‚å•</kbd>+<kbd>I</kbd> (Mac).</li>
          <li>Ve a la pesta√±a <b>Console</b> y pega:
            <pre style="background:#0f1524;border:1px solid var(--stroke);border-radius:10px;padding:10px;margin:8px 0 0"><code>localStorage.setItem("ferbot_api_base","https://ferbot-api-clean.onrender.com");
localStorage.getItem("ferbot_api_base");</code></pre>
            Debe devolver la misma URL.
          </li>
          <li>Recarga la p√°gina.</li>
        </ol>

        <h4 style="margin:12px 0 6px">4) Prueba r√°pida</h4>
        <ul class="small" style="margin:0 0 10px 16px; line-height:1.6">
          <li>Haz clic en el bot√≥n <b>Probar conexi√≥n</b>. Debe mostrar ‚Äú‚úÖ Conexi√≥n OK‚Äù.</li>
          <li>Abre FerBot, escribe una objeci√≥n corta y presiona <b>Generar</b>.</li>
        </ul>

        <div class="hr"></div>

        <h4 style="margin:12px 0 6px">Errores comunes y soluci√≥n</h4>
        <ul class="small" style="margin:0 0 6px 16px; line-height:1.6">
          <li><b>No aparece el bot√≥n ‚ÄúLoad unpacked‚Äù</b> ‚Üí Activa <b>Developer mode</b> en la esquina superior derecha.</li>
          <li><b>‚ÄúManifest no found‚Äù o carpeta vac√≠a</b> ‚Üí Aseg√∫rate de seleccionar la <b>carpeta descomprimida</b> que contiene <code>manifest.json</code> (no el ZIP).</li>
          <li><b>El bot no responde</b> ‚Üí Verifica <b>Probar conexi√≥n</b>. Si falla, vuelve a pegar el comando de <code>localStorage.setItem("ferbot_api_base", "...")</code> y recarga.</li>
          <li><b>Se demora la primera respuesta</b> ‚Üí Render puede ‚Äúdespertar‚Äù; intenta nuevamente tras unos segundos.</li>
          <li><b>Quiero actualizar</b> ‚Üí Si cambiaste <i>solo</i> respuestas del bot, no hace falta reinstalar: se actualizan en tiempo real tras <code>/admin/reloadTrainer</code>. Si cambiaste la extensi√≥n, vuelve a <b>chrome://extensions/</b> y pulsa <b>Update</b> o carga de nuevo.</li>
        </ul>

        <div class="hr"></div>

        <h4 style="margin:12px 0 6px">¬øNecesitas ayuda?</h4>
        <p class="small" style="margin:0">
          Slack: <b>@ferney salas</b> &nbsp;‚Ä¢&nbsp; Correo: <b>fsalas@platzi.com</b>
        </p>
      </div>
    </section>
  </div>

<script>
/* BASE y pista visual (panel original intacto) */
const BASE = (localStorage.getItem('ferbot_api_base') || '') || (location.origin);
const apiHintEl = document.getElementById('api-hint'); if(apiHintEl){ apiHintEl.textContent = BASE.replace(/^https?:\/\//,''); }

/* Link directo al ZIP en Drive (descarga autom√°tica) */
const DOWNLOAD_URL = "https://drive.google.com/uc?export=download&id=1VShxMQ5SKS62ZokbMwMoWzvLE0CDDFry";

/* Tabs (mostrar/ocultar secciones) */
const tabs = Array.from(document.querySelectorAll('.tab'));
const views = {
  'view-panel':   document.getElementById('view-panel'),
  'view-metrics': document.getElementById('view-metrics'),
  'view-ranking': document.getElementById('view-ranking'),
  'view-install': document.getElementById('view-install'),
};
tabs.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    tabs.forEach(t=>t.classList.remove('active')); btn.classList.add('active');
    Object.values(views).forEach(v=>v.classList.add('hidden'));
    const id = btn.getAttribute('data-view');
    if(views[id]) views[id].classList.remove('hidden');
  });
});

/* ==================== L√ìGICA ORIGINAL DEL PANEL (sin cambios) ==================== */
const nameEl = document.getElementById('name');
const stageEl= document.getElementById('stage');
const ctxEl  = document.getElementById('ctx');
const inEl   = document.getElementById('in');
const outEl  = document.getElementById('out');
const guideEl= document.getElementById('guide');
const btnGen = document.getElementById('gen');
const btnClr = document.getElementById('clr');
const btnGood= document.getElementById('g');
const btnReg = document.getElementById('r');
const btnBad = document.getElementById('b1');
const dot    = document.getElementById('b');
const timer  = document.getElementById('t');
const badge  = document.getElementById('sent');
const bTxt   = document.getElementById('sTxt');

let clock=null, t0=0, lastReply=null;
function start(){ stop(); t0=performance.now(); clock=setInterval(()=>{ const dt=(performance.now()-t0)/1000; timer.textContent=dt.toFixed(1)+'s'; dot.className='bullet'+(dt<2?'':' '+(dt<4?'amber':'green')); },100) }
function stop(){ if(clock) clearInterval(clock); clock=null; }
function toggleRatings(show){ [btnGood,btnReg,btnBad].forEach(x=>x.style.display=show?'inline-block':'none'); }
function sent(text){
  const s=(text||'').toLowerCase(); let cls='neu', t='Neutral';
  if (/(no puedo|caro|no sirve|dif√≠cil|no tengo tiempo)/i.test(s)) {cls='neg';t='Negativo'}
  else if (/(gracias|perfecto|me interesa|genial|bien)/i.test(s)) {cls='pos';t='Positivo'}
  badge.classList.remove('pos','neu','neg'); badge.classList.add(cls); bTxt.textContent=t;
}
document.getElementById('in').addEventListener('input',()=>sent(inEl.value));
document.addEventListener('mouseup',()=>setTimeout(()=>{const sel=window.getSelection()?.toString()?.trim(); if(sel){ inEl.value=sel; sent(sel); }},30));

document.getElementById('gen').onclick = async ()=>{
  const q=(inEl.value||'').trim(); if(!q){ alert('Escribe o selecciona un texto primero.'); return; }
  guideEl.value=''; outEl.value=''; toggleRatings(false); start();
  try{
    const r = await fetch(BASE+'/assist_trainer',{method:'POST',headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ question:q, customerName:(nameEl.value||'Cliente'), stage:stageEl.value, context:ctxEl.value })
    });
    stop(); dot.className='bullet green';
    if(!r.ok){ alert('No se pudo generar.'); return; }
    const j = await r.json();
    const reply = j?.result?.reply || j?.text || '';
    const why   = j?.result?.why || '';
    const next  = j?.result?.next || '';
    outEl.value = reply;
    guideEl.value = `POR QU√â: ${why}\nSIGUIENTE PASO: ${next}`;
    lastReply = reply; toggleRatings(true);
  }catch(e){ stop(); alert('No se pudo generar. Revisa que el servidor est√© arriba.'); }
};
document.getElementById('clr').onclick = ()=>{ inEl.value=''; outEl.value=''; guideEl.value=''; toggleRatings(false); stop(); dot.className='bullet'; timer.textContent='0.0s'; sent(''); };
document.getElementById('g').onclick=()=>rate('good');
document.getElementById('r').onclick=()=>rate('regular');
document.getElementById('b1').onclick=()=>rate('bad');

async function rate(kind){
  if(!lastReply) return; toggleRatings(false);
  try{
    await fetch(BASE+'/trackRate',{method:'POST',headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ rating:kind, text:lastReply, stage:stageEl.value, intent:guessIntent(inEl.value) })
    });
  }catch(_){}
}
function guessIntent(q=''){
  q=q.toLowerCase();
  if(/tiempo|agenda|ocupad/.test(q)) return 'tiempo';
  if(/precio|caro|costo|descuento/.test(q)) return 'precio';
  if(/cert/.test(q)) return 'cert';
  if(/coursera|udemy|alura|competenc/.test(q)) return 'competencia';
  if(/platzi|pitch/.test(q)) return 'pitch';
  return '_panel';
}

/* ===== Instalaci√≥n: botones ===== */
const dlLink  = document.getElementById('dl-link');
const copyBtn = document.getElementById('copy-dl');
const probeBtn= document.getElementById('probe');
const probeOut= document.getElementById('probe-out');

if (dlLink)  dlLink.href = DOWNLOAD_URL;

if (copyBtn) copyBtn.onclick = async () => {
  try {
    await navigator.clipboard.writeText(DOWNLOAD_URL);
    copyBtn.textContent = "¬°Copiado!";
    setTimeout(()=> copyBtn.textContent = "Copiar enlace", 900);
  } catch { alert("No se pudo copiar. Copia manual: " + DOWNLOAD_URL); }
};

if (probeBtn) probeBtn.onclick = async () => {
  probeOut.textContent = "Probando‚Ä¶";
  try {
    const r = await fetch(BASE + "/health");
    if (!r.ok) throw new Error("HTTP " + r.status);
    const j = await r.json();
    probeOut.textContent = j.ok ? "‚úÖ Conexi√≥n OK" : "‚ö†Ô∏è Respuesta inv√°lida";
  } catch (e) {
    probeOut.textContent = "‚ùå Sin conexi√≥n (" + (e.message || "error") + ")";
  }
};
</script>
</body>
</html>
