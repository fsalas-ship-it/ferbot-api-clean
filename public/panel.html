<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FerBot ¬∑ Panel</title>
<style>
/* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
   FerBot ¬∑ Panel unificado
   ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
:root{
  --platzi:#97C93E; --platzi-2:#7FB02F;
  --ink:#E6F2FF; --mut:#94a3b8;
  --card:#0f162a80; --stroke:rgba(255,255,255,.12);
  --field:#0f1524;
}
*{box-sizing:border-box}
html,body{
  height:100%; margin:0; color:var(--ink);
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
  background:
    radial-gradient(1200px 600px at 10% -20%, rgba(151,201,62,.18), transparent 60%),
    radial-gradient(1000px 500px at 100% 0%, rgba(151,201,62,.12), transparent 55%),
    linear-gradient(180deg, #0b0f19 0%, #0b0f19 35%, #0d1122 100%);
  overflow-y:auto;
}
body::before{
  content:""; position:fixed; inset:0;
  background:
    linear-gradient(to right, rgba(255,255,255,.03) 1px, transparent 1px) 0 0/24px 24px,
    linear-gradient(to bottom, rgba(255,255,255,.03) 1px, transparent 1px) 0 0/24px 24px;
  pointer-events:none; mask:linear-gradient(#000, transparent 85%);
}
.wrap{max-width:980px; margin:28px auto 64px; padding:0 16px}
.header{display:flex; align-items:center; justify-content:space-between; margin:0 0 12px}
h1{margin:0; font-size:22px; letter-spacing:.2px; display:flex; align-items:center; gap:10px}
h1::after{content:""; display:block; width:120px; height:2px; border-radius:2px;
  background:linear-gradient(90deg, rgba(151,201,62,.0), rgba(151,201,62,.65), rgba(151,201,62,.0));}

/* NAV (tabs) */
.nav{
  display:flex; gap:8px; margin:10px 0 16px; flex-wrap:wrap;
  background:rgba(16,23,39,.5); border:1px solid var(--stroke); border-radius:12px; padding:6px;
}
.tab{
  appearance:none; border:1px solid transparent; background:transparent; color:#bed6ff;
  padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700; letter-spacing:.2px;
}
.tab:hover{border-color:var(--stroke)}
.tab.active{
  color:#062d1f;
  background:linear-gradient(180deg, var(--platzi) 0%, var(--platzi-2) 100%);
  box-shadow: 0 6px 16px rgba(151,201,62,.2);
}

/* tarjeta glass */
.card{
  background:var(--card); border:1px solid var(--stroke);
  box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
  backdrop-filter: blur(8px); border-radius:18px; padding:18px; position:relative;
}
.card::before{
  content:""; position:absolute; inset:-1px; border-radius:18px; padding:1px;
  background:linear-gradient(135deg, rgba(151,201,62,.6), rgba(151,201,62,0) 45%, rgba(151,201,62,.35));
  -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none;
}

/* layout form */
.row{display:flex; gap:12px; align-items:flex-start}
.row>div{flex:1}
label{display:block; font-size:12px; color:var(--mut); margin:8px 0 6px}
input,select,textarea{
  width:100%; background:var(--field); border:1px solid var(--stroke); color:#D7E7FF;
  border-radius:12px; padding:12px 12px; outline:none; transition:border-color .15s, box-shadow .15s, background .2s;
}
textarea{min-height:96px; resize:vertical}
input:focus,select:focus,textarea:focus{border-color: rgba(151,201,62,.65); box-shadow: 0 0 0 3px rgba(151,201,62,.15)}

/* sentiment badge + timer */
.badge{
  display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:6px 10px;
  border-radius:999px; border:1px solid var(--stroke); background:rgba(16,23,39,.85); height:32px; margin:0 0 6px 6px;
}
.badge .dot{width:8px;height:8px;border-radius:50%; background:#64748b}
.badge.pos .dot{background:#22c55e} .badge.neu .dot{background:#f59e0b} .badge.neg .dot{background:#ef4444}
.signal{display:inline-flex; align-items:center; gap:8px; background:rgba(16,23,39,.8); border:1px solid var(--stroke); padding:6px 12px; border-radius:999px; font-variant-numeric:tabular-nums}
.bullet{width:10px;height:10px;border-radius:999px;background:#ef4444; box-shadow:0 0 12px #ef4444}
.bullet.amber{background:#f59e0b; box-shadow:0 0 12px #f59e0b}
.bullet.green{background:#22c55e; box-shadow:0 0 12px #22c55e}

/* botones */
.btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
.btn{padding:12px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:800; letter-spacing:.2px; transition: transform .05s ease, filter .2s}
.btn:active{ transform: translateY(1px) }
.primary{color:#062d1f;background:linear-gradient(180deg, var(--platzi) 0%, var(--platzi-2) 100%);box-shadow: 0 6px 16px rgba(151,201,62,.28)}
.ghost{ background:#1b2333; color:#cfe3ff; border:1px solid var(--stroke) }
.good{ background:#19c37d; color:#062d1f; display:none }
.reg { background:#fbbf24; color:#332200; display:none }
.bad { background:#ef4444; color:#fff; display:none }

/* helpers */
.hidden{display:none !important}
.footer{margin:18px 0 0; text-align:center; color:var(--mut); font-size:12px; opacity:.7}
.footer code{color:#8BD626}
.small{font-size:12px;color:#9fb6d6}
.hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0;border:0}
kbd{background:#0f1524;border:1px solid var(--stroke);border-radius:6px;padding:2px 6px;font-size:12px}

/* ====== M√âTRICAS (tarjetas y canvas) ====== */
.kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin:6px 0 14px}
.kpi{
  background:rgba(255,255,255,.04); border:1px solid var(--stroke); border-radius:14px; padding:12px;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.04);
}
.kpi .label{font-size:12px; color:var(--mut)}
.kpi .value{font-size:22px; font-weight:800; margin-top:4px}
.kpi .sub{font-size:12px; color:#9fb6d6; margin-top:4px}
.charts{display:grid; grid-template-columns:1fr; gap:12px}
@media (min-width: 900px){ .charts{grid-template-columns:1fr 1fr} }
.chart{
  background:rgba(255,255,255,.04); border:1px solid var(--stroke); border-radius:14px; padding:12px; position:relative;
}
.chart h4{margin:0 0 8px; font-size:14px; color:#cfe3ff}
canvas{width:100%; height:260px; display:block; background:linear-gradient(180deg, rgba(151,201,62,.05), rgba(151,201,62,0))}
.chart .hint{position:absolute; right:12px; top:12px; font-size:11px; color:#88a2c6; opacity:.9}
.badge-nd{display:inline-block; font-size:11px; padding:4px 8px; border-radius:999px; border:1px dashed rgba(255,255,255,.25); color:#a5b7d3}
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>FerBot ü§ñ ¬∑ Panel</h1>
      <span class="signal"><span id="b" class="bullet"></span><span id="t">0.0s</span></span>
    </div>

    <!-- NAV -->
    <nav class="nav">
      <button class="tab active" data-view="view-panel">Panel</button>
      <button class="tab" data-view="view-metrics">M√©tricas</button>
      <button class="tab" data-view="view-ranking">Ranking</button>
      <button class="tab" data-view="view-install">Instalaci√≥n</button>
    </nav>

    <!-- ====================== VISTA: PANEL ====================== -->
    <section id="view-panel">
      <div class="card">
        <div class="row">
          <div>
            <label>Nombre del cliente</label>
            <input id="name" placeholder="Ej. Laura"/>
          </div>
          <div>
            <label>Etapa</label>
            <select id="stage">
              <option value="integracion">Integraci√≥n</option>
              <option value="sondeo">Sondeo</option>
              <option value="rebatir" selected>Rebatir</option>
              <option value="pre_cierre">Pre-cierre</option>
              <option value="cierre">Cierre</option>
            </select>
          </div>
        </div>

        <label>Contexto (opcional)</label>
        <input id="ctx" placeholder="Notas breves para el bot..."/>

        <div class="row" style="align-items:flex-end;margin-top:10px">
          <div style="flex:1">
            <label>Texto del cliente / Objeci√≥n</label>
            <textarea id="in" placeholder="Selecciona texto del chat o escribe aqu√≠..."></textarea>
          </div>
          <div class="badge neu" id="sent">
            <span class="dot"></span><span id="sTxt">Neutral</span>
          </div>
        </div>

        <label>Explicaci√≥n (POR QU√â + SIGUIENTE PASO)</label>
        <textarea id="guide" placeholder="Aqu√≠ ver√°s POR QU√â y el SIGUIENTE PASO..."></textarea>

        <label>Respuesta (lista para pegar)</label>
        <textarea id="out" placeholder="Mensaje breve (‚â§ 2 frases)."></textarea>

        <div class="btns">
          <button id="gen" class="btn primary">Generar</button>
          <button id="clr" class="btn ghost">Clear</button>
          <button id="g" class="btn good">üëç Buena</button>
          <button id="r" class="btn reg">üòê Regular</button>
          <button id="b1" class="btn bad">üëé Mala</button>
        </div>

        <div class="footer">
          // api: <code id="api-hint">loading‚Ä¶</code>
        </div>
      </div>
    </section>

    <!-- ====================== VISTA: M√âTRICAS ====================== -->
    <section id="view-metrics" class="hidden">
      <div class="card">
        <h3 style="margin:0 0 12px">M√©tricas en tiempo real <span class="small">(auto-refresh cada 30s)</span></h3>

        <!-- KPIs -->
        <div class="kpis">
          <div class="kpi">
            <div class="label">Total mostradas</div>
            <div id="kpi-shown" class="value">‚Äî</div>
            <div id="kpi-shown-sub" class="sub">acumulado</div>
          </div>
          <div class="kpi">
            <div class="label">Wins</div>
            <div id="kpi-wins" class="value">‚Äî</div>
            <div class="sub">buenas + 0.5 regulares</div>
          </div>
          <div class="kpi">
            <div class="label">Winrate</div>
            <div id="kpi-winrate" class="value">‚Äî</div>
            <div class="sub">% sobre mostradas</div>
          </div>
          <div class="kpi">
            <div class="label">Usuarios activos</div>
            <div class="value"><span class="badge-nd">N/D</span></div>
            <div class="sub">requiere endpoint de actividad</div>
          </div>
        </div>

        <!-- Charts -->
        <div class="charts">
          <div class="chart">
            <h4>Consultas por intent</h4>
            <span class="hint">Fuente: /stats</span>
            <canvas id="chart-intent" width="600" height="260"></canvas>
          </div>
          <div class="chart">
            <h4>Top textos (m√°s mostrados)</h4>
            <span class="hint">Fuente: /stats</span>
            <canvas id="chart-top" width="600" height="260"></canvas>
          </div>
        </div>

        <div class="hr"></div>
        <p class="small">
          <b>Consultas por hora</b> y <b>Usuarios activos</b> necesitan un endpoint nuevo (p. ej. <code>/metrics/timeseries</code> con timestamps). Si quieres, siguiente paso te paso el diff m√≠nimo en <code>server.js</code> para registrarlo sin romper nada.
        </p>
      </div>
    </section>

    <!-- ====================== VISTA: RANKING (placeholder) ====================== -->
    <section id="view-ranking" class="hidden">
      <div class="card">
        <h3 style="margin:0 0 12px">Ranking de respuestas (pr√≥ximo paso)</h3>
        <p class="small">Tabla con winrate, shown, intent y stage, basada en <code>/stats</code>. Mismo look del panel.</p>
      </div>
    </section>

    <!-- ====================== VISTA: INSTALACI√ìN (completa) ====================== -->
    <section id="view-install" class="hidden">
      <div class="card">
        <h3 style="margin:0 0 12px">Instalaci√≥n r√°pida (Windows y Mac)</h3>

        <div class="row" style="gap:10px; align-items:center; margin-bottom:10px">
          <a id="dl-link" class="btn primary" href="#" download>‚¨áÔ∏è Descargar extensi√≥n (.zip)</a>
          <button id="copy-dl" class="btn ghost">Copiar enlace</button>
          <button id="probe" class="btn ghost">Probar conexi√≥n</button>
          <span id="probe-out" class="small"></span>
        </div>

        <div class="hr"></div>

        <h4 style="margin:8px 0 6px">1) Descarga y descomprime</h4>
        <ul class="small" style="margin:0 0 10px 16px; line-height:1.6">
          <li>Haz clic en <b>Descargar extensi√≥n (.zip)</b>.</li>
          <li>Abre el ZIP y <b>extrae</b> su contenido a una carpeta. Dentro debes ver <code>manifest.json</code> y <code>contentScript.js</code>.</li>
        </ul>

        <h4 style="margin:8px 0 6px">2) Carga la extensi√≥n en el navegador</h4>
        <div class="row">
          <div>
            <b>Windows (Chrome/Edge)</b>
            <ol class="small" style="margin:6px 0 0 18px; line-height:1.6">
              <li>Abre <b>chrome://extensions/</b> en Chrome (o <b>edge://extensions/</b> en Edge).</li>
              <li>Activa <b>Developer mode</b> (arriba a la derecha).</li>
              <li>Haz clic en <b>Load unpacked</b> / <b>Cargar descomprimida</b>.</li>
              <li>Selecciona la carpeta que descomprimiste (donde est√° <code>manifest.json</code>).</li>
            </ol>
          </div>
          <div>
            <b>Mac (Chrome)</b>
            <ol class="small" style="margin:6px 0 0 18px; line-height:1.6">
              <li>Abre <b>chrome://extensions/</b>.</li>
              <li>Activa <b>Developer mode</b>.</li>
              <li>Clic en <b>Load unpacked</b>.</li>
              <li>Elige la carpeta descomprimida (con <code>manifest.json</code> adentro).</li>
            </ol>
          </div>
        </div>

        <h4 style="margin:12px 0 6px">3) Conectar con el backend (una sola vez)</h4>
        <p class="small" style="margin:0 0 8px">Abre la p√°gina donde usar√°s FerBot (Hilos). Luego:</p>
        <ol class="small" style="margin:0 0 10px 18px; line-height:1.6">
          <li>Abre las herramientas de desarrollador: <kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>I</kbd> (Windows) o <kbd>‚åò</kbd>+<kbd>‚å•</kbd>+<kbd>I</kbd> (Mac).</li>
          <li>Ve a la pesta√±a <b>Console</b> y pega:
            <pre style="background:#0f1524;border:1px solid var(--stroke);border-radius:10px;padding:10px;margin:8px 0 0"><code>localStorage.setItem("ferbot_api_base","https://ferbot-api-clean.onrender.com");
localStorage.getItem("ferbot_api_base");</code></pre>
            Debe devolver la misma URL.
          </li>
          <li>Recarga la p√°gina.</li>
        </ol>

        <h4 style="margin:12px 0 6px">4) Prueba r√°pida</h4>
        <ul class="small" style="margin:0 0 10px 16px; line-height:1.6">
          <li>Haz clic en el bot√≥n <b>Probar conexi√≥n</b>. Debe mostrar ‚Äú‚úÖ Conexi√≥n OK‚Äù.</li>
          <li>Abre FerBot, escribe una objeci√≥n corta y presiona <b>Generar</b>.</li>
        </ul>

        <div class="hr"></div>

        <h4 style="margin:12px 0 6px">Errores comunes y soluci√≥n</h4>
        <ul class="small" style="margin:0 0 6px 16px; line-height:1.6">
          <li><b>No aparece el bot√≥n ‚ÄúLoad unpacked‚Äù</b> ‚Üí Activa <b>Developer mode</b> en la esquina superior derecha.</li>
          <li><b>‚ÄúManifest no found‚Äù o carpeta vac√≠a</b> ‚Üí Aseg√∫rate de seleccionar la <b>carpeta descomprimida</b> que contiene <code>manifest.json</code> (no el ZIP).</li>
          <li><b>El bot no responde</b> ‚Üí Verifica <b>Probar conexi√≥n</b>. Si falla, vuelve a pegar el comando de <code>localStorage.setItem("ferbot_api_base", "...")</code> y recarga.</li>
          <li><b>Se demora la primera respuesta</b> ‚Üí Render puede ‚Äúdespertar‚Äù; intenta nuevamente tras unos segundos.</li>
          <li><b>Quiero actualizar</b> ‚Üí Si cambiaste <i>solo</i> respuestas del bot, no hace falta reinstalar: se actualizan en tiempo real tras <code>/admin/reloadTrainer</code>. Si cambiaste la extensi√≥n, vuelve a <b>chrome://extensions/</b> y pulsa <b>Update</b> o carga de nuevo.</li>
        </ul>

        <div class="hr"></div>

        <h4 style="margin:12px 0 6px">¬øNecesitas ayuda?</h4>
        <p class="small" style="margin:0">
          Slack: <b>@ferney salas</b> &nbsp;‚Ä¢&nbsp; Correo: <b>fsalas@platzi.com</b>
        </p>
      </div>
    </section>
  </div>

<script>
/* BASE y pista visual */
const BASE = (localStorage.getItem('ferbot_api_base') || '') || (location.origin);
const apiHintEl = document.getElementById('api-hint'); if(apiHintEl){ apiHintEl.textContent = BASE.replace(/^https?:\/\//,''); }

/* Link directo al ZIP en Drive */
const DOWNLOAD_URL = "https://drive.google.com/uc?export=download&id=1VShxMQ5SKS62ZokbMwMoWzvLE0CDDFry";

/* Tabs */
const tabs = Array.from(document.querySelectorAll('.tab'));
const views = {
  'view-panel':   document.getElementById('view-panel'),
  'view-metrics': document.getElementById('view-metrics'),
  'view-ranking': document.getElementById('view-ranking'),
  'view-install': document.getElementById('view-install'),
};
tabs.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    tabs.forEach(t=>t.classList.remove('active')); btn.classList.add('active');
    Object.values(views).forEach(v=>v.classList.add('hidden'));
    const id = btn.getAttribute('data-view');
    if(views[id]) views[id].classList.remove('hidden');
  });
});

/* ==================== L√ìGICA ORIGINAL DEL PANEL ==================== */
const nameEl = document.getElementById('name');
const stageEl= document.getElementById('stage');
const ctxEl  = document.getElementById('ctx');
const inEl   = document.getElementById('in');
const outEl  = document.getElementById('out');
const guideEl= document.getElementById('guide');
const btnGen = document.getElementById('gen');
const btnClr = document.getElementById('clr');
const btnGood= document.getElementById('g');
const btnReg = document.getElementById('r');
const btnBad = document.getElementById('b1');
const dot    = document.getElementById('b');
const timer  = document.getElementById('t');
const badge  = document.getElementById('sent');
const bTxt   = document.getElementById('sTxt');

let clock=null, t0=0, lastReply=null;
function start(){ stop(); t0=performance.now(); clock=setInterval(()=>{ const dt=(performance.now()-t0)/1000; timer.textContent=dt.toFixed(1)+'s'; dot.className='bullet'+(dt<2?'':' '+(dt<4?'amber':'green')); },100) }
function stop(){ if(clock) clearInterval(clock); clock=null; }
function toggleRatings(show){ [btnGood,btnReg,btnBad].forEach(x=>x.style.display=show?'inline-block':'none'); }
function sent(text){
  const s=(text||'').toLowerCase(); let cls='neu', t='Neutral';
  if (/(no puedo|caro|no sirve|dif√≠cil|no tengo tiempo)/i.test(s)) {cls='neg';t='Negativo'}
  else if (/(gracias|perfecto|me interesa|genial|bien)/i.test(s)) {cls='pos';t='Positivo'}
  badge.classList.remove('pos','neu','neg'); badge.classList.add(cls); bTxt.textContent=t;
}
document.getElementById('in').addEventListener('input',()=>sent(inEl.value));
document.addEventListener('mouseup',()=>setTimeout(()=>{const sel=window.getSelection()?.toString()?.trim(); if(sel){ inEl.value=sel; sent(sel); }},30));

document.getElementById('gen').onclick = async ()=>{
  const q=(inEl.value||'').trim(); if(!q){ alert('Escribe o selecciona un texto primero.'); return; }
  guideEl.value=''; outEl.value=''; toggleRatings(false); start();
  try{
    const r = await fetch(BASE+'/assist_trainer',{method:'POST',headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ question:q, customerName:(nameEl.value||'Cliente'), stage:stageEl.value, context:ctxEl.value })
    });
    stop(); dot.className='bullet green';
    if(!r.ok){ alert('No se pudo generar.'); return; }
    const j = await r.json();
    const reply = j?.result?.reply || j?.text || '';
    const why   = j?.result?.why || '';
    const next  = j?.result?.next || '';
    outEl.value = reply;
    guideEl.value = `POR QU√â: ${why}\nSIGUIENTE PASO: ${next}`;
    lastReply = reply; toggleRatings(true);
  }catch(e){ stop(); alert('No se pudo generar. Revisa que el servidor est√© arriba.'); }
};
document.getElementById('clr').onclick = ()=>{ inEl.value=''; outEl.value=''; guideEl.value=''; toggleRatings(false); stop(); dot.className='bullet'; timer.textContent='0.0s'; sent(''); };
document.getElementById('g').onclick=()=>rate('good');
document.getElementById('r').onclick=()=>rate('regular');
document.getElementById('b1').onclick=()=>rate('bad');

async function rate(kind){
  if(!lastReply) return; toggleRatings(false);
  try{
    await fetch(BASE+'/trackRate',{method:'POST',headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ rating:kind, text:lastReply, stage:stageEl.value, intent:guessIntent(inEl.value) })
    });
  }catch(_){}
}
function guessIntent(q=''){
  q=q.toLowerCase();
  if(/tiempo|agenda|ocupad/.test(q)) return 'tiempo';
  if(/precio|caro|costo|descuento/.test(q)) return 'precio';
  if(/cert/.test(q)) return 'cert';
  if(/coursera|udemy|alura|competenc/.test(q)) return 'competencia';
  if(/platzi|pitch/.test(q)) return 'pitch';
  return '_panel';
}

/* ===== Instalaci√≥n: botones ===== */
const dlLink  = document.getElementById('dl-link');
const copyBtn = document.getElementById('copy-dl');
const probeBtn= document.getElementById('probe');
const probeOut= document.getElementById('probe-out');
if (dlLink)  dlLink.href = DOWNLOAD_URL;
if (copyBtn) copyBtn.onclick = async () => {
  try { await navigator.clipboard.writeText(DOWNLOAD_URL); copyBtn.textContent = "¬°Copiado!"; setTimeout(()=> copyBtn.textContent = "Copiar enlace", 900); }
  catch { alert("No se pudo copiar. Copia manual: " + DOWNLOAD_URL); }
};
if (probeBtn) probeBtn.onclick = async () => {
  probeOut.textContent = "Probando‚Ä¶";
  try { const r = await fetch(BASE + "/health"); if (!r.ok) throw new Error("HTTP " + r.status); const j = await r.json(); probeOut.textContent = j.ok ? "‚úÖ Conexi√≥n OK" : "‚ö†Ô∏è Respuesta inv√°lida"; }
  catch (e) { probeOut.textContent = "‚ùå Sin conexi√≥n (" + (e.message || "error") + ")"; }
};

/* ===== M√©tricas (auto-refresh cada 30s) ===== */
const kShown = document.getElementById('kpi-shown');
const kWins  = document.getElementById('kpi-wins');
const kRate  = document.getElementById('kpi-winrate');

const cIntent = document.getElementById('chart-intent');
const cTop    = document.getElementById('chart-top');

async function fetchStats(){
  const r = await fetch(BASE + '/stats');
  if(!r.ok) throw new Error('HTTP '+r.status);
  const j = await r.json();
  return j?.rows || [];
}

function summarize(rows){
  let shown=0, wins=0;
  const byIntent = {};
  for(const r of rows){
    shown += Number(r.shown||0);
    wins  += Number(r.wins||0);
    const it = r.intent || '_';
    byIntent[it] = (byIntent[it]||0) + Number(r.shown||0);
  }
  const winrate = shown>0 ? (wins/shown) : 0;
  // top por mostradas
  const top = [...rows].sort((a,b)=> (b.shown-a.shown) || ((b.winrate||0)-(a.winrate||0))).slice(0,8);
  return { shown, wins, winrate, byIntent, top };
}

/* ‚Äî‚Äî‚Äî Render ‚Äú3D-fake‚Äù en canvas ‚Äî‚Äî‚Äî */
function draw3DBars(canvas, labels, values, opts={}){
  if(!canvas) return;
  const DPR = window.devicePixelRatio||1;
  const ctx = canvas.getContext('2d');
  const W = canvas.clientWidth * DPR, H = canvas.clientHeight * DPR;
  if(canvas.width!==W) canvas.width=W;
  if(canvas.height!==H) canvas.height=H;
  ctx.clearRect(0,0,W,H);

  const pad = 28*DPR;
  const baseY = H - pad*1.2;
  const maxV = Math.max(1, ...values);
  const n = values.length;
  const gap = 18*DPR;
  const bw = Math.max(24*DPR, (W - pad*2 - gap*(n-1)) / n);
  const ox = pad;

  // eje
  ctx.strokeStyle = 'rgba(255,255,255,.15)';
  ctx.lineWidth = 1*DPR;
  ctx.beginPath(); ctx.moveTo(pad, baseY); ctx.lineTo(W-pad/2, baseY); ctx.stroke();

  // escalas
  ctx.fillStyle = 'rgba(255,255,255,.45)';
  ctx.font = `${12*DPR}px ui-sans-serif`;
  ctx.textAlign = 'center';
  // barras
  for(let i=0;i<n;i++){
    const v = values[i];
    const h = (v/maxV) * (H - pad*3);
    const x = ox + i*(bw+gap);
    const y = baseY - h;

    // 3D faces (isom√©trico simple)
    const front = ctx.createLinearGradient(0,y,0,baseY);
    front.addColorStop(0, 'rgba(151,201,62,.95)');
    front.addColorStop(1, 'rgba(127,176,47,.85)');
    const side = 'rgba(70,95,22,.65)';
    const topc = 'rgba(190,230,110,.95)';

    // sombra
    ctx.fillStyle = 'rgba(0,0,0,.25)';
    ctx.beginPath(); ctx.rect(x+3*DPR, y+6*DPR, bw, h); ctx.fill();

    // frente
    ctx.fillStyle = front;
    ctx.beginPath(); ctx.rect(x, y, bw, h); ctx.fill();

    // ‚Äútecho‚Äù
    const t = 8*DPR, s = 6*DPR;
    ctx.fillStyle = topc;
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x+t, y-t);
    ctx.lineTo(x+bw+t, y-t);
    ctx.lineTo(x+bw, y);
    ctx.closePath(); ctx.fill();

    // ‚Äúlado‚Äù
    ctx.fillStyle = side;
    ctx.beginPath();
    ctx.moveTo(x+bw, y);
    ctx.lineTo(x+bw+t, y-t);
    ctx.lineTo(x+bw+t, baseY-t);
    ctx.lineTo(x+bw, baseY);
    ctx.closePath(); ctx.fill();

    // label
    const lbl = (labels[i]||'').toString().slice(0,10);
    ctx.save();
    ctx.translate(x+bw/2, baseY + 16*DPR);
    ctx.rotate(-Math.PI/12);
    ctx.fillStyle = 'rgba(200,225,255,.85)';
    ctx.fillText(lbl, 0, 0);
    ctx.restore();

    // valor
    ctx.fillStyle = 'rgba(220,255,220,.9)';
    ctx.textAlign='right';
    ctx.fillText(String(v), x+bw-2*DPR, y-6*DPR);
    ctx.textAlign='center';
  }
}

function updateKPIs(sum){
  kShown.textContent = sum.shown.toLocaleString('es-CO');
  kWins.textContent  = sum.wins.toLocaleString('es-CO');
  kRate.textContent  = (sum.winrate*100).toFixed(1) + '%';
}

async function refreshMetrics(){
  try{
    const rows = await fetchStats();
    const sum  = summarize(rows);
    updateKPIs(sum);

    // intent chart
    const intents = Object.keys(sum.byIntent);
    const valsI   = intents.map(k=> sum.byIntent[k]||0);
    draw3DBars(cIntent, intents, valsI);

    // top texts chart (use shown)
    const labelsTop = sum.top.map(r=>{
      const t = (r.text||'').replace(/\s+/g,' ').trim();
      return t.length>20 ? t.slice(0,20)+'‚Ä¶' : t;
    });
    const valsTop = sum.top.map(r=> Number(r.shown||0));
    draw3DBars(cTop, labelsTop, valsTop);
  }catch(e){
    // si falla, no rompemos la UI
    console.warn('metrics error', e);
  }
}

// primera carga y auto-refresh 30s
refreshMetrics();
setInterval(refreshMetrics, 30_000);

/* ==================== FIN M√âTRICAS ==================== */
</script>
</body>
</html>
